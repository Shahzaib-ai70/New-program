<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitsafe Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .nav-item.active { background-color: #374151; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 text-white fixed h-full">
      <div class="px-4 py-4 flex items-center border-b border-gray-800">
        <i class="fa-brands fa-bitcoin text-yellow-400 text-2xl mr-2"></i>
        <span class="text-xl font-bold">Bitsafe</span>
      </div>
      <nav class="mt-4 space-y-1">
        <a href="#" onclick="showSection('dashboard')" class="nav-item block px-4 py-3 text-sm hover:bg-gray-800 active" id="nav-dashboard">
          <i class="fa-solid fa-chart-line w-5 mr-2"></i> Dashboard
        </a>
        <a href="#" onclick="showSection('users')" class="nav-item block px-4 py-3 text-sm hover:bg-gray-800" id="nav-users">
          <i class="fa-solid fa-users w-5 mr-2"></i> User Management
        </a>
        <a href="#" onclick="showSection('finance')" class="nav-item block px-4 py-3 text-sm hover:bg-gray-800" id="nav-finance">
          <i class="fa-solid fa-money-bill-transfer w-5 mr-2"></i> Deposit & Withdraw
        </a>
        <a href="#" onclick="showSection('trades')" class="nav-item block px-4 py-3 text-sm hover:bg-gray-800" id="nav-trades">
          <i class="fa-solid fa-gavel w-5 mr-2"></i> Trade Handling
        </a>
        <a href="#" onclick="showSection('verifications')" class="nav-item block px-4 py-3 text-sm hover:bg-gray-800" id="nav-verifications">
          <i class="fa-solid fa-id-card w-5 mr-2"></i> Real Name Verification
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64">
      <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10">
        <div class="text-lg font-bold text-gray-800" id="pageTitle">Dashboard</div>
        <div class="flex items-center space-x-4">
          <span class="text-sm font-medium text-gray-600">Admin</span>
          <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
            <i class="fa-solid fa-user text-gray-500"></i>
          </div>
        </div>
      </header>

      <div class="p-8">
        <!-- Dashboard Section -->
        <div id="section-dashboard" class="space-y-6">
          <div class="grid grid-cols-4 gap-6">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Total Net Deposit</div>
              <div class="text-gray-900 font-bold text-2xl" id="platformRechargeUpDown">0.00</div>
              <div class="mt-2 text-xs text-green-600 flex items-center">
                <i class="fa-solid fa-arrow-up mr-1"></i> All time
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Total Orders</div>
              <div class="text-gray-900 font-bold text-2xl" id="platformOrders">0</div>
              <div class="mt-2 text-xs text-blue-600 flex items-center">
                <i class="fa-solid fa-chart-simple mr-1"></i> All time
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Today's Net Deposit</div>
              <div class="text-gray-900 font-bold text-2xl" id="todayRechargeUpDown">0.00</div>
              <div class="mt-2 text-xs text-green-600 flex items-center">
                <i class="fa-solid fa-calendar-day mr-1"></i> Today
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Today's Orders</div>
              <div class="text-gray-900 font-bold text-2xl" id="todayOrders">0</div>
              <div class="mt-2 text-xs text-blue-600 flex items-center">
                <i class="fa-solid fa-calendar-day mr-1"></i> Today
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="section-users" class="hidden space-y-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800">New Members</h3>
              <button onclick="loadUsers()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                  <tr>
                    <th class="px-6 py-3">ID</th>
                    <th class="px-6 py-3">Username</th>
                    <th class="px-6 py-3">Balance</th>
                    <th class="px-6 py-3">Joined At</th>
                    <th class="px-6 py-3">Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTable" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Finance Section -->
        <div id="section-finance" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Deposits -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800">Deposit Requests</h3>
              <button onclick="loadDeposits()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                  <tr>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3">Amount</th>
                    <th class="px-4 py-3">Proof</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="depositsTable" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>

          <!-- Withdrawals -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800">Withdrawal Requests</h3>
              <button onclick="loadWithdrawals()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                  <tr>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3">Amount</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="withdrawalsTable" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Trade Handling Section -->
        <div id="section-trades" class="hidden space-y-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-800 mb-4">Trade Control</h3>
            <div class="flex items-center space-x-4">
              <span class="text-sm font-medium text-gray-600">Force Win Side:</span>
              <div class="flex bg-gray-100 p-1 rounded-lg">
                <button onclick="setWinSide('long')" id="btn-win-long" class="px-4 py-2 rounded-md text-sm font-medium transition-colors">Long Wins</button>
                <button onclick="setWinSide('short')" id="btn-win-short" class="px-4 py-2 rounded-md text-sm font-medium transition-colors">Short Wins</button>
              </div>
              <span id="winSideStatus" class="text-xs text-gray-400 italic">Current: -</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">When a user opens a trade, if their direction matches this setting, they win. Otherwise they lose.</p>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
             <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800">Recent Trades</h3>
              <button onclick="loadTrades()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                  <tr>
                    <th class="px-6 py-3">ID</th>
                    <th class="px-6 py-3">User</th>
                    <th class="px-6 py-3">Symbol</th>
                    <th class="px-6 py-3">Side</th>
                    <th class="px-6 py-3">Amount</th>
                    <th class="px-6 py-3">Result</th>
                    <th class="px-6 py-3">Profit</th>
                    <th class="px-6 py-3">Time</th>
                  </tr>
                </thead>
                <tbody id="tradesTable" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Real Name Verification Section -->
        <div id="section-verifications" class="hidden space-y-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800">Real Name Verification</h3>
              <button onclick="loadVerifications()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                  <tr>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3">Type</th>
                    <th class="px-4 py-3">Doc Type</th>
                    <th class="px-4 py-3">Doc Number</th>
                    <th class="px-4 py-3">Images</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="verificationsTable" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const apiBase = location.origin.replace(/\/admin$/, '');

    // Navigation
    function showSection(section) {
      document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById('section-' + section).classList.remove('hidden');
      
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-gray-800'));
      document.getElementById('nav-' + section).classList.add('active', 'bg-gray-800');

      const titles = {
        'dashboard': 'Dashboard',
        'users': 'User Management',
        'finance': 'Deposit & Withdraw',
        'trades': 'Trade Handling',
        'verifications': 'Real Name Verification'
      };
      document.getElementById('pageTitle').textContent = titles[section];

      if(section === 'users') loadUsers();
      if(section === 'finance') { loadDeposits(); loadWithdrawals(); }
      if(section === 'trades') { loadTrades(); checkWinSide(); }
      if(section === 'verifications') { loadVerifications(); }
    }

    // Load Summary
    async function loadSummary() {
      try {
        const r = await fetch(apiBase + '/api/admin/summary');
        const j = await r.json();
        document.getElementById('platformRechargeUpDown').textContent = j.platformRechargeUpDown.toFixed(2);
        document.getElementById('platformOrders').textContent = j.platformOrders;
        document.getElementById('todayRechargeUpDown').textContent = j.todayRechargeUpDown.toFixed(2);
        document.getElementById('todayOrders').textContent = j.todayOrders;
      } catch(e) { console.error(e); }
    }

    // Load Users
    async function loadUsers() {
      const users = await (await fetch(apiBase + '/api/admin/users')).json();
      document.getElementById('usersTable').innerHTML = users.map(u => `
        <tr>
          <td class="px-6 py-4 font-medium text-gray-900">#${u.id}</td>
          <td class="px-6 py-4">${u.username}</td>
          <td class="px-6 py-4 font-bold text-green-600">${u.balance.toFixed(2)}</td>
          <td class="px-6 py-4 text-gray-500">${new Date(u.created_at).toLocaleString()}</td>
          <td class="px-6 py-4">
             <button onclick="editBalance('${u.username}', ${u.balance})" class="text-blue-600 hover:text-blue-800 text-xs font-medium">Edit Balance</button>
          </td>
        </tr>
      `).join('');
    }

    async function editBalance(username, current) {
      const newBal = prompt(`Edit balance for ${username}:`, current);
      if(newBal !== null && !isNaN(parseFloat(newBal))) {
        await fetch(apiBase + '/api/admin/users/balance', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, balance: parseFloat(newBal) })
        });
        loadUsers();
      }
    }

    // Finance
    function actionButtons(type, id, status) {
      if(status !== 'pending') return `<span class="px-2 py-1 rounded-full text-xs font-medium ${status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${status}</span>`;
      return `
        <button onclick="updateStatus('${type}', '${id}', 'approved')" class="px-3 py-1 bg-green-500 text-white rounded text-xs mr-1 hover:bg-green-600">Approve</button>
        <button onclick="updateStatus('${type}', '${id}', 'rejected')" class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Reject</button>
      `;
    }

    async function updateStatus(type, id, status) {
      let endpoint = '';
      if(type === 'deposit') endpoint = `/api/deposit/${id}/status`;
      else if(type === 'withdraw') endpoint = `/api/withdraw/${id}/status`;
      else if(type === 'verification') endpoint = `/api/admin/verification/${id}/status`;
      await fetch(apiBase + endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status })
      });
      if(type === 'deposit') loadDeposits();
      else if(type === 'withdraw') loadWithdrawals();
      else if(type === 'verification') loadVerifications();
    }

    async function loadDeposits() {
      const d = await (await fetch(apiBase + '/api/deposits')).json();
      document.getElementById('depositsTable').innerHTML = d.map(x => `
        <tr>
          <td class="px-4 py-3">${x.username || 'Unknown'}</td>
          <td class="px-4 py-3">${x.amount} ${x.currency}</td>
          <td class="px-4 py-3">
             ${x.proof_image ? `<a href="${apiBase}${x.proof_image}" target="_blank" class="text-blue-500 hover:underline"><i class="fa-solid fa-image"></i> View</a>` : '-'}
          </td>
          <td class="px-4 py-3"><span class="capitalize">${x.status}</span></td>
          <td class="px-4 py-3">${actionButtons('deposit', x.id, x.status)}</td>
        </tr>
      `).join('');
    }

    async function loadWithdrawals() {
      const w = await (await fetch(apiBase + '/api/withdrawals')).json();
      document.getElementById('withdrawalsTable').innerHTML = w.map(x => `
        <tr>
          <td class="px-4 py-3">${x.username || 'Unknown'}</td>
          <td class="px-4 py-3">${x.amount} ${x.currency}</td>
          <td class="px-4 py-3"><span class="capitalize">${x.status}</span></td>
          <td class="px-4 py-3">${actionButtons('withdraw', x.id, x.status)}</td>
        </tr>
      `).join('');
    }

    // Trades
    async function loadTrades() {
      const t = await (await fetch(apiBase + '/api/trades')).json();
      document.getElementById('tradesTable').innerHTML = t.map(x => `
        <tr>
          <td class="px-6 py-4">#${x.id}</td>
          <td class="px-6 py-4">${x.username}</td>
          <td class="px-6 py-4">${x.symbol}</td>
          <td class="px-6 py-4 uppercase ${x.side === 'long' ? 'text-green-600' : 'text-red-600'}">${x.side}</td>
          <td class="px-6 py-4">${x.amount}</td>
          <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${x.result === 'win' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} uppercase">${x.result}</span></td>
          <td class="px-6 py-4 font-medium ${x.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${x.profit.toFixed(2)}</td>
          <td class="px-6 py-4 text-xs text-gray-500">${new Date(x.created_at).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    async function loadVerifications() {
      const list = await (await fetch(apiBase + '/api/admin/verifications')).json();
      document.getElementById('verificationsTable').innerHTML = list.map(v => `
        <tr>
          <td class="px-4 py-3">${v.username || '-'}</td>
          <td class="px-4 py-3 capitalize">${v.kind}</td>
          <td class="px-4 py-3">${v.document_type || '-'}</td>
          <td class="px-4 py-3">${v.document_number || '-'}</td>
          <td class="px-4 py-3 space-x-2">
            ${v.front_image ? `<a href="${apiBase}${v.front_image}" target="_blank" class="text-blue-500 hover:underline">Front</a>` : ''}
            ${v.back_image ? `<a href="${apiBase}${v.back_image}" target="_blank" class="text-blue-500 hover:underline">Back</a>` : ''}
            ${v.selfie_image ? `<a href="${apiBase}${v.selfie_image}" target="_blank" class="text-blue-500 hover:underline">Selfie</a>` : ''}
          </td>
          <td class="px-4 py-3"><span class="capitalize">${v.status}</span></td>
          <td class="px-4 py-3">${actionButtons('verification', v.id, v.status)}</td>
        </tr>
      `).join('');
    }

    async function setWinSide(side) {
      await fetch(apiBase + '/api/admin/winside', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ side })
      });
      checkWinSide(side);
    }

    async function checkWinSide(optimisticSide) {
      if(optimisticSide) {
         updateWinSideUI(optimisticSide);
         return;
      }
      // Note: We don't have a GET for winside, but we can infer or add it. 
      // For now, let's just use the setter to init or simple UI state.
      // Actually, let's just rely on button clicks for now as state isn't persisted in DB, just memory.
      // Default is 'short' per server code.
    }

    function updateWinSideUI(side) {
      document.getElementById('btn-win-long').className = `px-4 py-2 rounded-md text-sm font-medium transition-colors ${side === 'long' ? 'bg-green-600 text-white shadow' : 'text-gray-600 hover:bg-gray-200'}`;
      document.getElementById('btn-win-short').className = `px-4 py-2 rounded-md text-sm font-medium transition-colors ${side === 'short' ? 'bg-red-600 text-white shadow' : 'text-gray-600 hover:bg-gray-200'}`;
      document.getElementById('winSideStatus').textContent = 'Current: ' + side.toUpperCase() + ' wins';
    }

    // Init
    loadSummary();
    updateWinSideUI('short'); // Default server state
    // Poll for real-time updates
    setInterval(loadSummary, 5000);
  </script>
</body>
</html>
